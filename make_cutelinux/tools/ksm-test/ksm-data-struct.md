# KSM 数据结构关系图

## 1. 整体架构关系图

```
┌────────────────────────────────────────────────────────────────┐
│                          KSM 全局数据结构                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────┐         ┌──────────────────────┐      │
│  │  root_stable_tree   │         │ root_unstable_tree   │      │
│  │  (红黑树根数组)     │         │  (红黑树根数组)      │      │
│  │  [NUMA节点0]        │         │  [NUMA节点0]         │      │
│  │  [NUMA节点1]        │         │  [NUMA节点1]         │      │
│  │  [NUMA节点...]      │         │  [NUMA节点...]       │      │
│  └──────┬──────────────┘         └──────┬───────────────┘      │
│         │                               │                      │
│         │  存储已合并页面               │  存储候选页面        │
│         │  (写保护的KSM页)              │  (每轮扫描后重建)    │
│         │                               │                      │
│         ↓                               ↓                      │
│  ┌──────────────┐               ┌──────────────┐               │
│  │ stable_node  │               │ rmap_item    │               │
│  │ stable_node  │               │ rmap_item    │               │
│  │ stable_node  │               │ rmap_item    │               │
│  └──────────────┘               └──────────────┘               │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           mm_slots_hash (全局哈希表)                    │   │
│  │  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┐     │   │
│  │  │bucket│bucket│bucket│bucket│bucket│bucket│bucket│     │   │
│  │  │  0   │  1   │  2   │  3   │  4   │  5   │ ...  │     │   │
│  │  └───┬──┴──────┴──────┴──────┴──────┴──────┴──────┘     │   │
│  │      │                                                  │   │
│  │      └─→ mm_slot链表                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │        ksm_mm_head (全局mm_slot链表头)                  │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐           │   │
│  │  │ mm_slot  │───→│ mm_slot  │───→│ mm_slot  │──→ ...    │   │
│  │  │ (进程A)  │    │ (进程B)  │    │ (进程C)  │           │   │
│  │  └──────────┘    └──────────┘    └──────────┘           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │          ksm_scan (全局扫描游标)                        │   │
│  │  ┌────────────────────────────────────────────┐         │   │
│  │  │ mm_slot: 指向当前扫描的进程                │         │   │
│  │  │ address: 当前扫描的虚拟地址                │         │   │
│  │  │ rmap_list: 指向当前rmap_item               │         │   │
│  │  │ seqnr: 扫描轮次序号                        │         │   │
│  │  └────────────────────────────────────────────┘         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 2. 单个进程的数据结构关系

```
┌────────────────────────────────────────────────────────────────────┐
│                         进程 (mm_struct)                           │
│                                                                    │
│  调用 madvise(addr, len, MADV_MERGEABLE)                           │
│                          ↓                                         │
│                   ┌──────────────┐                                 │
│                   │   mm_slot    │  ← 每个进程一个                 │
│                   ├──────────────┤                                 │
│                   │ link         │──→ 链入 mm_slots_hash           │
│                   │ mm_list      │──→ 链入 ksm_mm_head             │
│                   │ rmap_list ───┼──→ 指向该进程的rmap_item链表    │
│                   │ mm           │──→ 指向 mm_struct               │
│                   └──────────────┘                                 │
│                          │                                         │
│                          │ rmap_list                               │
│                          ↓                                         │
│         ┌────────────────────────────────────────────┐             │
│         │   该进程的所有被跟踪页面 (rmap_item链表)   │             │
│         └────────────────────────────────────────────┘             │
│                          │                                         │
│         ┌────────────────┴─────────────────┐                       │
│         ↓                ↓                 ↓                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                │
│  │  rmap_item   │ │  rmap_item   │ │  rmap_item   │                │
│  │  (虚拟页1)   │→│  (虚拟页2)   │→│  (虚拟页3)   │→ ...           │
│  ├──────────────┤ ├──────────────┤ ├──────────────┤                │
│  │ rmap_list    │ │ rmap_list    │ │ rmap_list    │                │
│  │ mm           │ │ mm           │ │ mm           │                │
│  │ address      │ │ address      │ │ address      │                │
│  │ oldchecksum  │ │ oldchecksum  │ │ oldchecksum  │                │
│  │              │ │              │ │              │                │
│  │ [状态]       │ │ [状态]       │ │ [状态]       │                │
│  │ 可能是:      │ │ 可能是:      │ │ 可能是:      │                │
│  │ - 在稳定树   │ │ - 在不稳定树 │ │ - 尚未进树   │                │
│  └──────────────┘ └──────────────┘ └──────────────┘                │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## 3. 稳定树的详细结构

```
┌───────────────────────────────────────────────────────────────────────┐
│                   稳定树 (已合并的KSM页面)                            │
│                      红黑树结构                                       │
└───────────────────────────────────────────────────────────────────────┘

                          ┌──────────────┐
                          │ stable_node  │  ← 红黑树根
                          │   (根节点)   │
                          └───┬──────┬───┘
                              │      │
                 ┌────────────┘      └────────────┐
                 ↓                                ↓
          ┌──────────────┐                 ┌──────────────┐
          │ stable_node  │                 │ stable_node  │
          │   (左子树)   │                 │   (右子树)   │
          └──────────────┘                 └──────────────┘

每个 stable_node 的内部结构:

┌────────────────────────────────────────────────────────────────────┐
│                      stable_node                                   │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ node (rb_node)        ← 红黑树节点                          │   │
│  │ kpfn                  ← 物理页帧号 (指向实际的KSM页)        │   │
│  │ rmap_hlist_len        ← 共享计数 (多少虚拟页共享这个物理页) │   │
│  │ nid                   ← NUMA节点ID                          │   │
│  │                                                             │   │
│  │ hlist (hlist_head)    ← 反向映射链表头                      │   │
│  └────────┬────────────────────────────────────────────────────┘   │
│           │                                                        │
│           │ 链接所有映射到这个物理页的虚拟页                       │
│           ↓                                                        │
│  ┌────────────────────────────────────────────────┐                │
│  │      使用这个KSM页面的所有rmap_item            │                │
│  └────────────────────────────────────────────────┘                │
│           │                                                        │
│      ┌────┴────┬────────┬────────┬────────┐                        │
│      ↓         ↓        ↓        ↓        ↓                        │
│  ┌────────┐┌────────┐┌────────┐┌────────┐┌────────┐                │
│  │rmap_   ││rmap_   ││rmap_   ││rmap_   ││rmap_   │                │
│  │item    ││item    ││item    ││item    ││item    │                │
│  │(进程A) ││(进程A) ││(进程B) ││(进程C) ││(进程D) │                │
│  │vaddr1  ││vaddr2  ││vaddr3  ││vaddr4  ││vaddr5  │                │
│  └────────┘└────────┘└────────┘└────────┘└────────┘                │
│                                                                    │
│  说明: 5个不同的虚拟页面映射到同一个物理页面                       │
│       rmap_hlist_len = 5                                           │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

物理内存视图:

┌─────────────────────────────────────────┐
│      物理页面 (Page Frame)              │
│      PFN = stable_node->kpfn            │
├─────────────────────────────────────────┤
│  [  K  S  M     P  A  G  E  ]           │
│  [  写  保  护  的  内  容  ]           │
│  [  多个进程共享这个物理页  ]           │
└─────────────────────────────────────────┘
         ↑     ↑      ↑        ↑      ↑
         │     │      │        │      │
    ┌────┘     │      │        │      └────┐
    │          │      │        │           │
┌───┴───┐  ┌───┴───┐ ┌┴─────┐ ┌┴─────┐ ┌───┴───┐
│进程A  │  │进程A  │ │进程B │ │进程C │ │进程D  │
│页表项1│  │页表项2│ │页表  │ │页表  │ │页表项 │
│(只读) │  │(只读) │ │(只读)│ │(只读)│ │(只读) │
└───────┘  └───────┘ └──────┘ └──────┘ └───────┘
```

## 4. 不稳定树的详细结构

```
┌───────────────────────────────────────────────────────────────────────┐
│                 不稳定树 (候选合并的页面)                             │
│                      红黑树结构                                       │
│                   每轮扫描后完全重建                                  │
└───────────────────────────────────────────────────────────────────────┘

                          ┌──────────────┐
                          │  rmap_item   │  ← 红黑树根
                          │   (根节点)   │
                          └───┬──────┬───┘
                              │      │
                 ┌────────────┘      └────────────┐
                 ↓                                ↓
          ┌──────────────┐                 ┌──────────────┐
          │  rmap_item   │                 │  rmap_item   │
          │   (左子树)   │                 │   (右子树)   │
          └──────────────┘                 └──────────────┘

每个 rmap_item (在不稳定树中) 的结构:

┌───────────────────────────────────────────────────────────────────┐
│                   rmap_item (不稳定状态)                          │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐     │
│  │ node (rb_node)        ← 红黑树节点                       │     │
│  │ mm                    ← 指向所属进程的mm_struct          │     │
│  │ address               ← 虚拟地址 | UNSTABLE_FLAG         │     │
│  │ oldchecksum           ← 页面内容的校验和                 │     │
│  │ nid                   ← NUMA节点ID                       │     │
│  └──────────────────────────────────────────────────────────┘     │
│                                                                   │
│  指向实际的物理页面:                                              │
│  ┌─────────────────────────────────────┐                          │
│  │      物理页面 (普通匿名页)          │                          │
│  │      可读写的                       │                          │
│  │      尚未合并                       │                          │
│  └─────────────────────────────────────┘                          │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘

不稳定树的生命周期:

┌────────────┐      ┌────────────┐      ┌────────────┐
│  扫描轮次N │      │ 扫描轮次N+1│      │扫描轮次N+2 │
├────────────┤      ├────────────┤      ├────────────┤
│            │      │            │      │            │
│ 构建不稳定 │ ───→ │ 清空重建   │ ───→ │ 清空重建   │
│ 树         │      │ 不稳定树   │      │ 不稳定树   │
│            │      │            │      │            │
│ 发现匹配   │      │ 发现匹配   │      │ 发现匹配   │
│ ↓          │      │ ↓          │      │ ↓          │
│ 创建KSM页  │      │ 创建KSM页  │      │ 创建KSM页  │
│ ↓          │      │ ↓          │      │ ↓          │
│ 加入稳定树 │      │ 加入稳定树 │      │ 加入稳定树 │
│            │      │            │      │            │
└────────────┘      └────────────┘      └────────────┘
```

## 5. rmap_item 的状态转换图

```
┌─────────────────────────────────────────────────────────────────────┐
│                   rmap_item 生命周期                                │
└─────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │  创建 rmap_item  │  ← alloc_rmap_item()
    │   初始状态       │     address没有任何标志
    └────────┬─────────┘
             │
             ↓
    ┌──────────────────┐
    │  第一次扫描      │
    │  计算校验和      │
    │  oldchecksum设置 │
    └────────┬─────────┘
             │
             ↓
    ┌──────────────────────────────────────────┐
    │  插入不稳定树                            │
    │  address |= UNSTABLE_FLAG                │
    │  address |= seqnr (序列号)               │
    │  加入 root_unstable_tree 红黑树          │
    └────────┬─────────────────────────────────┘
             │
             ├─────────────┐
             │             │
             ↓             ↓
    ┌─────────────┐   ┌─────────────────┐
    │  未找到匹配 │   │  找到匹配页面   │
    │  等待下次   │   │  (在不稳定树中) │
    │  扫描       │   └────────┬────────┘
    └─────────────┘            │
             │                 │
             │                 ↓
             │       ┌──────────────────┐
             │       │  合并两个页面    │
             │       │  创建KSM页面     │
             │       │  创建stable_node │
             │       └────────┬─────────┘
             │                │
             │                ↓
             │     ┌─────────────────────────┐
             │     │  插入稳定树             │
             │     │  address &= PAGE_MASK   │
             │     │  address |= STABLE_FLAG │
             │     │  链入stable_node->hlist │
             │     │  设置anon_vma           │
             │     └──────────┬──────────────┘
             │                │
             ↓                ↓
    ┌────────────────────────────────────┐
    │  rmap_item 在稳定树中              │
    │  address & STABLE_FLAG != 0        │
    │  anon_vma 有效                     │
    │  head 指向 stable_node             │
    │  hlist 链入 stable_node->hlist     │
    └────────────────┬───────────────────┘
                     │
                     ↓
    ┌────────────────────────────────────┐
    │  写保护页面                        │
    │  物理页面被多个虚拟地址共享        │
    │  写入时触发COW                     │
    └────────────────┬───────────────────┘
                     │
                     │  发生写操作
                     ↓
    ┌────────────────────────────────────┐
    │  COW (写时复制)                    │
    │  1. 分配新的物理页面               │
    │  2. 复制内容                       │
    │  3. 修改页表指向新页面             │
    │  4. 清除写保护                     │
    │  5. rmap_item从稳定树移除          │
    └────────────────┬───────────────────┘
                     │
                     ↓
    ┌────────────────────────────────────┐
    │  回到初始状态                      │
    │  address 标志清零                  │
    │  可能在下次扫描时重新进入不稳定树  │
    └────────────────────────────────────┘


状态标志位说明:

address 字段的低位编码:
┌─────────────────────────────────────────────────────┐
│  bits  │  含义                                      │
├────────┼────────────────────────────────────────────┤
│  0-7   │  SEQNR_MASK (0x0ff)                        │
│        │  扫描序列号,用于判断rmap_item的"年龄"      │
├────────┼────────────────────────────────────────────┤
│  8     │  UNSTABLE_FLAG (0x100)                     │
│        │  设置时表示在不稳定树中                    │
├────────┼────────────────────────────────────────────┤
│  9     │  STABLE_FLAG (0x200)                       │
│        │  设置时表示在稳定树中                      │
├────────┼────────────────────────────────────────────┤
│ 10-63  │  实际的虚拟地址 (对齐到页边界)             │
│        │  address & PAGE_MASK                       │
└─────────────────────────────────────────────────────┘
```

## 6. KSM扫描过程中的数据流

```
┌──────────────────────────────────────────────────────────────────────┐
│                        ksmd 线程扫描流程                             │
└──────────────────────────────────────────────────────────────────────┘

第一步: 选择进程和页面
─────────────────────
        ┌─────────────────┐
        │  ksm_scan       │
        │  .mm_slot ──────┼──→ 指向当前进程的 mm_slot
        │  .address       │    当前扫描的虚拟地址
        │  .rmap_list     │    当前rmap_item指针
        └─────────────────┘
                │
                ↓
        ┌─────────────────┐
        │   mm_slot       │
        │   .mm           │──→ 进程的 mm_struct
        │   .rmap_list    │──→ 该进程的所有rmap_item
        └─────────────────┘
                │
                ↓
        ┌─────────────────┐
        │  VMA (虚拟内存) │
        │  vm_start       │
        │  vm_end         │
        │  vm_flags       │──→ 检查 VM_MERGEABLE
        └─────────────────┘
                │
                ↓
        ┌─────────────────┐
        │  follow_page()  │──→ 获取物理页面
        └─────────────────┘
                │
                ↓
        ┌─────────────────┐
        │   struct page   │
        └─────────────────┘


第二步: 查找匹配
─────────────────

        ┌─────────────────┐
        │  page (要扫描)  │
        └────────┬────────┘
                 │
                 ↓
        ┌─────────────────────────┐
        │  计算页面校验和         │
        │  memcmp_pages()         │
        └────────┬────────────────┘
                 │
                 ├──────────────────────────────┐
                 │                              │
                 ↓                              ↓
    ┌────────────────────────┐      ┌──────────────────────┐
    │  在稳定树中查找        │      │  在不稳定树中查找    │
    │  stable_tree_search()  │      │  unstable_tree_      │
    │                        │      │  search_insert()     │
    └────────┬───────────────┘      └──────────┬───────────┘
             │                                 │
             │                                 │
      找到 KSM 页                        找到候选页
             │                                 │
             ↓                                 ↓
    ┌────────────────────────┐      ┌──────────────────────┐
    │  try_to_merge_with_    │      │  try_to_merge_two_   │
    │  ksm_page()            │      │  pages()             │
    │                        │      │                      │
    │  合并到现有KSM页       │      │  创建新的KSM页       │
    └────────┬───────────────┘      └──────────┬───────────┘
             │                                 │
             └──────────┬──────────────────────┘
                        │
                        ↓
            ┌───────────────────────┐
            │  更新 rmap_item       │
            │  加入 stable_node     │
            └───────────────────────┘


第三步: 页面合并细节
─────────────────────

   虚拟页A (进程1)              虚拟页B (进程2)
         │                            │
         │                            │
         ↓                            ↓
   ┌──────────┐                 ┌──────────┐
   │ 物理页A  │                 │ 物理页B  │
   │ [内容X]  │                 │ [内容X]  │  ← 内容相同
   └──────────┘                 └──────────┘
         │                            │
         │                            │
         └──────────┬─────────────────┘
                    │
                    ↓  memcmp_pages() 比较成功
                    │
         ┌──────────────────────┐
         │  创建 stable_node    │
         │  设置写保护          │
         └──────────┬───────────┘
                    │
                    ↓

   合并后:

   虚拟页A (进程1)    虚拟页B (进程2)
         │                    │
         │ (只读)             │ (只读)
         └──────┬─────────────┘
                │
                ↓
         ┌──────────────┐
         │ 物理页A      │  ← 成为 KSM 页
         │ [内容X]      │     (写保护)
         │              │
         │ 物理页B被释放│
         └──────────────┘
                ↑
                │
         ┌──────────────┐
         │ stable_node  │
         │ .kpfn = A    │
         │ .hlist ──────┼─→ rmap_item(进程1) → rmap_item(进程2)
         └──────────────┘


第四步: 写时复制 (COW)
────────────────────────

   进程2尝试写入:

         虚拟页B (进程2)
               │
               │  写操作
               ↓
         ┌──────────────┐
         │ 页错误       │
         │ (写保护错误) │
         └──────┬───────┘
                │
                ↓
         ┌─────────────┐
         │ 分配新页面  │
         │ 复制内容    │
         └──────┬──────┘
                │
                ↓

   虚拟页A (进程1)              虚拟页B (进程2)
         │                            │
         │ (只读)                     │ (可写)
         ↓                            ↓
   ┌───────────┐                 ┌──────────┐
   │ 物理页A   │                 │ 新物理页 │
   │ [内容X]   │                 │ [内容X]  │
   │           │                 │          │
   │ 仍是KSM页 │                 │ 普通页面 │
   └───────────┘                 └──────────┘
         ↑
         │
   ┌──────────────┐
   │ stable_node  │
   │ .kpfn = A    │
   │ .hlist ──────┼─→ rmap_item(进程1) 只剩一个
   └──────────────┘         最后这个COW时候删除

   进程2的rmap_item从稳定树移除,
   下次扫描可能重新加入不稳定树
```

## 7. 完整示例: 三个进程共享一个页面

```
┌──────────────────────────────────────────────────────────────────────┐
│               三个进程共享同一个物理页面的示例                       │
└──────────────────────────────────────────────────────────────────────┘

初始状态:
─────────

进程A                进程B                进程C
  │                   │                    │
  │ VMA1              │ VMA1               │ VMA1
  │ 0x1000            │ 0x2000             │ 0x3000
  ↓                   ↓                    ↓
┌──────┐            ┌──────┐            ┌──────┐
│Page A│            │Page B│            │Page C│
│[data]│            │[data]│            │[data]│  ← 内容都相同
└──────┘            └──────┘            └──────┘


KSM扫描和合并过程:
──────────────────

第1轮扫描:
  扫描进程A, 页面A
    → 计算校验和
    → 稳定树:未找到
    → 不稳定树:未找到
    → 创建rmap_item_A
    → 插入不稳定树

  扫描进程B, 页面B
    → 计算校验和
    → 稳定树:未找到
    → 不稳定树:找到 rmap_item_A!
    → 比较内容: 匹配!
    → 合并页面A和B
    → 创建stable_node
    → 释放页面B

  此时的数据结构:

  进程A                进程B
    │                   │
    │ 0x1000            │ 0x2000
    │ (只读)            │ (只读)
    └─────┬─────────────┘
          │
          ↓
      ┌──────┐
      │Page A│  ← KSM页 (写保护)
      │[data]│
      └───┬──┘
          │
    ┌─────┴──────┐
    │stable_node │
    │ kpfn = A   │
    │ hlist:     │
    └─────┬──────┘
          │
    ┌─────┴──────────────────┐
    │                        │
    ↓                        ↓
┌────────────┐            ┌───────────┐
│rmap_item   │            │rmap_item  │
│(进程A)     │            │(进程B)    │
│addr=0x1000 │            │addr=0x2000│
│STABLE      │            │STABLE     │
└────────────┘            └───────────┘

  扫描进程C, 页面C
    → 计算校验和
    → 稳定树:找到stable_node!
    → 比较内容: 匹配!
    → 合并页面C到KSM页A
    → 释放页面C
    → 创建rmap_item_C
    → 链入stable_node

  最终状态:

  进程A         进程B         进程C
    │             │             │
    │ 0x1000      │ 0x2000      │ 0x3000
    │ (只读)      │ (只读)      │ (只读)
    └──────┬──────┴──────┬──────┘
           │             │
           └──────┬──────┘
                  │
                  ↓
              ┌──────┐
              │Page A│  ← 唯一的物理页 (KSM页)
              │[data]│     写保护
              └───┬──┘     Page B, C 已释放
                  │        节省了 2 个页面!
            ┌─────┴──────┐
            │stable_node │
            │ kpfn = A   │
            │ len = 3    │  ← 共享计数
            │ hlist:     │
            └─────┬──────┘
                  │
        ┌─────────┼─────────┐
        │         │         │
        ↓         ↓         ↓
    ┌────────┐┌────────┐┌────────┐
    │rmap_A  ││rmap_B  ││rmap_C  │
    │0x1000  ││0x2000  ││0x3000  │
    │进程A   ││进程B   ││进程C   │
    └────────┘└────────┘└────────┘


统计信息:
─────────
  ksm_pages_shared  = 1  (stable_node数量)
  ksm_pages_sharing = 2  (额外共享的页面数)
  节省内存 = 2 * PAGE_SIZE = 8KB (假设页面4KB)


如果进程B写入页面:
──────────────────
进程B: write to 0x2000
  ↓
检测到页面是只读的（写保护）
  ↓
触发页错误（Page Fault）
  ↓
do_wp_page() - 处理写保护页错误
  ↓
检测到这是一个KSM页面（PageKsm(page) == true）
  ↓
分配新的物理页面 Page_B_new
  ↓
复制内容: Page A → Page_B_new
  ↓
修改进程B的页表项:
  - 虚拟地址 0x2000 → Page_B_new（新物理页）
  - 清除写保护位（设为可写）
  ↓
从stable_node的hlist中移除rmap_B
  ↓
stable_node->rmap_hlist_len--  (3 → 2)
  ↓
更新统计:
  - ksm_pages_sharing--  (减少一个共享)

  新状态:

进程A                        进程B         进程C
  │                            │             │
  │ 0x1000                     │ 0x2000      │ 0x3000
  │ (只读)                     │ (可写)      │ (只读)
  └────────┬───────────────────┘      │      └─┬─────
           │                          │        │
           │ 仍然共享 KSM 页面        │        │
           └──────────────────────────┼────────┘
                                      │
                  ┌───────────────────┴───────────────────┐
                  │                                       │
                  ↓                                       ↓
              ┌──────┐                              ┌───────────┐
              │Page A│  ← 仍是KSM页面               │Page_B_new │
              │[data]│    (写保护)                  │[data*]    │ ← 新的独立页面
              └───┬──┘    进程A和C仍共享这个页面    └───────────┘    可读写
                  │                                       ↑
            ┌─────┴──────┐                                │
            │stable_node │                                │
            │ kpfn = A   │                            进程B的页表
            │ len = 2    │  ← 共享计数: 3→2              指向这里
            │ hlist:     │
            └─────┬──────┘
                  │
            ┌─────┴─────┐
            │           │
            ↓           ↓
        ┌────────┐  ┌────────┐
        │rmap_A  │  │rmap_C  │  ← 只剩这两个在stable_node中
        │0x1000  │  │0x3000  │
        │进程A   │  │进程C   │
        └────────┘  └────────┘

  rmap_B 被移除,下次扫描时可能重新进入不稳定树
```

## 8. 内存布局总览

```
┌────────────────────────────────────────────────────────────────────┐
│                       KSM 完整内存布局                             │
└────────────────────────────────────────────────────────────────────┘

全局数据区:
┌─────────────────────────────────────────────────────────────┐
│  静态分配的全局变量                                         │
├─────────────────────────────────────────────────────────────┤
│  • root_stable_tree[n]      ← 稳定树数组                    │
│  • root_unstable_tree[n]    ← 不稳定树数组                  │
│  • mm_slots_hash            ← mm_slot哈希表                 │
│  • ksm_mm_head              ← mm_slot全局链表               │
│  • ksm_scan                 ← 扫描游标                      │
│  • ksm_pages_shared         ← 统计: 共享页数                │
│  • ksm_pages_sharing        ← 统计: 额外共享数              │
│  • ...                                                      │
└─────────────────────────────────────────────────────────────┘

Slab缓存区:
┌─────────────────────────────────────────────────────────────┐
│  rmap_item_cache                                            │
│  ┌──────┬──────┬──────┬──────┬──────┐                       │
│  │rmap  │rmap  │rmap  │rmap  │rmap  │ ...                   │
│  │item  │item  │item  │item  │item  │                       │
│  └──────┴──────┴──────┴──────┴──────┘                       │
├─────────────────────────────────────────────────────────────┤
│  stable_node_cache                                          │
│  ┌──────┬──────┬──────┬──────┐                              │
│  │stable│stable│stable│stable│ ...                          │
│  │node  │node  │node  │node  │                              │
│  └──────┴──────┴──────┴──────┘                              │
├─────────────────────────────────────────────────────────────┤
│  mm_slot_cache                                              │
│  ┌──────┬──────┬──────┬──────┐                              │
│  │mm    │mm    │mm    │mm    │ ...                          │
│  │slot  │slot  │slot  │slot  │                              │
│  └──────┴──────┴──────┴──────┘                              │
└─────────────────────────────────────────────────────────────┘

物理内存:
┌────────────────────────────────────────────────────────────┐
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ KSM Page 1 │  │ KSM Page 2 │  │ KSM Page 3 │            │
│  │ (写保护)   │  │ (写保护)   │  │ (写保护)   │            │
│  │ 被多个进程 │  │ 被多个进程 │  │ 被多个进程 │            │
│  │ 共享       │  │ 共享       │  │ 共享       │            │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │
│        │               │               │                   │
│        │               │               │                   │
│           对应的stable_node在稳定树中                      │
│        ↓               ↓               ↓                   │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐               │
│  │stable   │     │stable   │     │stable   │               │
│  │node 1   │     │node 2   │     │node 3   │               │
│  │kpfn=X   │     │kpfn=Y   │     │kpfn=Z   │               │
│  └─────────┘     └─────────┘     └─────────┘               │
│                                                            │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ 普通页面   │  │ 普通页面   │  │ 普通页面   │            │
│  │ (可写)     │  │ (可写)     │  │ (可写)     │            │
│  │ 未被KSM    │  │ 在不稳定树 │  │ 待扫描     │            │
│  │ 管理       │  │ 中         │  │            │            │
│  └────────────┘  └────────────┘  └────────────┘            │
└────────────────────────────────────────────────────────────┘

进程地址空间:
┌────────────────────────────────────────────────────────────┐
│  进程A的虚拟地址空间                                       │
│  ┌────────────────────────────────────────────┐            │
│  │ 0x00000000 - 0x7fffffff (用户空间)         │            │
│  │                                            │            │
│  │  代码段 (.text)                            │            │
│  │  数据段 (.data)                            │            │
│  │  ┌───────────────────────┐                 │            │
│  │  │ VMA (VM_MERGEABLE)    │ ← madvise标记   │            │
│  │  │ 0x10000000-0x10100000 │                 │            │
│  │  │                       │                 │            │
│  │  │ 页面1 (0x10000)  ─────┼──→ KSM Page     │            │
│  │  │ 页面2 (0x11000)  ─────┼──→ 普通页面     │            │
│  │  │ 页面3 (0x12000)  ─────┼──→ KSM Page     │            │
│  │  │ ...                   │                 │            │
│  │  └───────────────────────┘                 │            │
│  │  堆 (heap)                                 │            │
│  │  栈 (stack)                                │            │
│  └────────────────────────────────────────────┘            │
└────────────────────────────────────────────────────────────┘
```

